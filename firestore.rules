
rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Helper function to check for admin role
    function isAdmin() {
      return isSignedIn() && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.isAdmin == true;
    }

    // Helper function to check if the user is signed in
    function isSignedIn() {
      return request.auth != null;
    }

    // --- User Data ---
    // Users can read their own data.
    // Users can only create their own user document.
    // Users can update their own data.
    match /users/{userId} {
      allow read, update: if isSignedIn() && request.auth.uid == userId;
      allow create: if isSignedIn() && request.auth.uid == userId;
    }
    
    // --- Publicly Readable Data ---
    // Services, Promotions, Theme, SocialMedia, GalleryImages, and public content can be read by anyone.
    // Only admins can create, update, or delete them.
    match /services/{serviceId} {
      allow read: if true;
      allow write: if isAdmin();
    }

    match /promotions/{promotionId} {
      allow read: if true;
      allow write: if isAdmin();
    }
    
    match /galleryImages/{imageId} {
       allow read: if true;
       allow write: if isAdmin();
    }
    
    match /content/{contentId} {
       allow read: if true;
       allow write: if isAdmin();
    }

    match /theme/{themeId} {
      allow read: if true;
      allow write: if isAdmin();
    }

    match /socialMedia/{docId} {
      allow read: if true;
      allow write: if isAdmin();
    }

    // --- Configuration Data ---
    // BusinessHours are public, but only admin writable.
    // Other configs are admin-only.
    match /config/businessHours {
      allow read: if true;
      allow write: if isAdmin();
    }
    match /config/notifications {
      allow read, write: if isAdmin();
    }

    // --- Appointments ---
    // Admins can read/write all appointments.
    // Users can create their own appointments.
    // Users can list their own appointments via a query (where('clientId', '==', uid)).
    // Users can read/update their own specific appointment.
    match /appointments/{appointmentId} {
        allow get: if isAdmin() || (isSignedIn() && resource.data.clientId == request.auth.uid);
        allow list: if isAdmin() || (isSignedIn() && request.query.where.clientId == request.auth.uid);
        allow create: if isSignedIn() && request.resource.data.clientId == request.auth.uid;
        allow update: if isAdmin() || (isSignedIn() && resource.data.clientId == request.auth.uid);
        allow delete: if isAdmin();

        // --- Chat Messages Subcollection ---
        // Only the client of the appointment or an admin can read/write messages.
        match /messages/{messageId} {
            allow read, write: if isSignedIn() && (get(/databases/$(database)/documents/appointments/$(appointmentId)).data.clientId == request.auth.uid || isAdmin());
        }
    }
  }
}

    